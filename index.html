<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>PDF Flipbook Viewer</title>
    <script src="https://unpkg.com/page-flip/dist/js/page-flip.browser.js"></script>
    <style>
        * {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        body {
            margin: 0;
            padding: 0;
            background-color: #121212;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            -webkit-overflow-scrolling: touch;
        }
        #book {
            margin: auto;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            z-index: 1000;
        }
        .error {
            color: white;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
<div id="loading" class="loading">Loading pages...</div>
<div id="book"></div>
<script>
    (async function() {
        const urlParams = new URLSearchParams(window.location.search);
        const dir = urlParams.get('dir');

        if (!dir) {
            document.body.innerHTML = '<div class="error"><h1>No directory specified. Use ?dir=example</h1></div>';
            return;
        }

        const bookContainer = document.getElementById('book');
        const loading = document.getElementById('loading');
        let pageIndex = 0;
        const pages = [];

        // Load all pages first
        while (true) {
            const pageUrl = `pdfs/${dir}/page_${String(pageIndex).padStart(2, '0')}.jpg`;

            try {
                const response = await fetch(pageUrl, { method: 'HEAD' });
                if (!response.ok) {
                    break;
                }
                pages.push(pageUrl);
                pageIndex++;
            } catch (error) {
                break;
            }
        }

        if (pages.length === 0) {
            document.body.innerHTML = '<div class="error"><h1>No pages found in the specified directory.</h1></div>';
            return;
        }

        // Calculate dimensions - use actual image aspect ratio (800x1200 = portrait)
        const pageAspectRatio = 2 / 3; // width / height for portrait pages (800/1200)
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        
        let pageWidth, pageHeight;
        
        // Calculate page size to fit viewport
        pageWidth = Math.floor(viewportWidth / 2.5);
        pageHeight = Math.floor(pageWidth / pageAspectRatio);
        
        // Ensure it fits in viewport
        if (pageHeight > viewportHeight * 0.9) {
            pageHeight = Math.floor(viewportHeight * 0.9);
            pageWidth = Math.floor(pageHeight * pageAspectRatio);
        }

        // Initialize PageFlip
        const pageFlip = new St.PageFlip(bookContainer, {
            width: pageWidth,
            height: pageHeight,
            size: "fixed",
            minWidth: 315,
            maxWidth: 1000,
            minHeight: 400,
            maxHeight: 1533,
            showCover: false,
            drawShadow: true,
            flippingTime: 1000,
            usePortrait: true,
            startZIndex: 0,
            autoSize: true,
            maxShadowOpacity: 0.5,
            mobileScrollSupport: true
        });

        // Load images
        pageFlip.loadFromImages(pages);

        loading.style.display = 'none';

        // Handle window resize
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                const newViewportWidth = window.innerWidth;
                const newViewportHeight = window.innerHeight;
                
                let newPageWidth = Math.floor(newViewportWidth / 2.5);
                let newPageHeight = Math.floor(newPageWidth / pageAspectRatio);
                
                if (newPageHeight > newViewportHeight * 0.9) {
                    newPageHeight = Math.floor(newViewportHeight * 0.9);
                    newPageWidth = Math.floor(newPageHeight * pageAspectRatio);
                }
                
                // Recreate the book with new dimensions
                const currentPage = pageFlip.getCurrentPageIndex();
                pageFlip.destroy();
                
                const newPageFlip = new St.PageFlip(bookContainer, {
                    width: newPageWidth,
                    height: newPageHeight,
                    size: "fixed",
                    minWidth: 315,
                    maxWidth: 1000,
                    minHeight: 400,
                    maxHeight: 1533,
                    showCover: false,
                    drawShadow: true,
                    flippingTime: 1000,
                    usePortrait: true,
                    startZIndex: 0,
                    autoSize: true,
                    maxShadowOpacity: 0.5,
                    mobileScrollSupport: true
                });
                
                newPageFlip.loadFromImages(pages);
                newPageFlip.turnToPage(currentPage);
                
                // Update reference
                window.pageFlip = newPageFlip;
            }, 250);
        });
        
        // Store reference for resize
        window.pageFlip = pageFlip;
    })();
</script>
</body>
</html>
