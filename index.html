<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Flipbook Viewer</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/turn.js/4/turn.min.js"></script>
    <style>
        * {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        body {
            margin: 0;
            padding: 0;
            background-color: #121212;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            -webkit-overflow-scrolling: touch;
        }
        #flipbook {
            margin: auto;
            position: relative;
            touch-action: pan-x;
        }
        #flipbook .page {
            background-color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        #flipbook .page img {
            max-width: 100%;
            max-height: 100%;
            width: 100%;
            height: 100%;
            object-fit: contain;
            pointer-events: none;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            z-index: 1000;
        }
        .error {
            color: white;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
<div id="loading" class="loading">Loading pages...</div>
<div id="flipbook" style="display: none;"></div>
<script>
    (async function() {
        const urlParams = new URLSearchParams(window.location.search);
        const dir = urlParams.get('dir');

        if (!dir) {
            document.body.innerHTML = '<div class="error"><h1>No directory specified. Use ?dir=example</h1></div>';
            return;
        }

        const flipbook = document.getElementById('flipbook');
        const loading = document.getElementById('loading');
        let pageIndex = 0;
        const pages = [];

        // Load all pages first
        while (true) {
            const pageUrl = `pdfs/${dir}/page_${String(pageIndex).padStart(2, '0')}.jpg`;

            try {
                const response = await fetch(pageUrl, { method: 'HEAD' });
                if (!response.ok) {
                    break;
                }
                pages.push(pageUrl);
                pageIndex++;
            } catch (error) {
                break;
            }
        }

        if (pages.length === 0) {
            document.body.innerHTML = '<div class="error"><h1>No pages found in the specified directory.</h1></div>';
            return;
        }

        // Calculate dimensions - use actual image aspect ratio (800x1200 = portrait)
        const pageAspectRatio = 2 / 3; // width / height for portrait pages (800/1200)
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        
        // Determine if we're on mobile or desktop
        const isMobile = viewportWidth <= 768;
        let pageWidth, pageHeight, flipbookWidth;
        
        if (isMobile) {
            // Mobile: single page view - prioritize height to show full page
            pageHeight = Math.floor(viewportHeight * 0.9);
            pageWidth = Math.floor(pageHeight * pageAspectRatio);
            
            // If page is too wide, constrain by width
            if (pageWidth > viewportWidth * 0.9) {
                pageWidth = Math.floor(viewportWidth * 0.9);
                pageHeight = Math.floor(pageWidth / pageAspectRatio);
            }
            
            flipbookWidth = pageWidth; // Single page width
        } else {
            // Desktop: double page spread
            pageWidth = Math.floor(viewportWidth / 2.5);
            pageHeight = Math.floor(pageWidth / pageAspectRatio);
            
            // Ensure it fits in viewport
            if (pageHeight > viewportHeight * 0.9) {
                pageHeight = Math.floor(viewportHeight * 0.9);
                pageWidth = Math.floor(pageHeight * pageAspectRatio);
            }
            
            flipbookWidth = pageWidth * 2; // Double page width
        }

        // Add pages to flipbook
        pages.forEach((pageUrl) => {
            const pageDiv = document.createElement('div');
            pageDiv.className = 'page';
            
            const img = document.createElement('img');
            img.src = pageUrl;
            img.alt = 'Page';
            
            pageDiv.appendChild(img);
            flipbook.appendChild(pageDiv);
        });

        loading.style.display = 'none';
        flipbook.style.display = 'block';

        // Wait for images to load before initializing turn.js
        const imagePromises = pages.map(pageUrl => {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = resolve;
                img.onerror = resolve;
                img.src = pageUrl;
            });
        });

        await Promise.all(imagePromises);

        // Initialize turn.js with mobile-friendly settings
        $('#flipbook').turn({
            width: flipbookWidth,
            height: pageHeight,
            autoCenter: true,
            display: isMobile ? 'single' : 'double',
            acceleration: true,
            gradients: !isMobile,
            elevation: 50,
            when: {
                turning: function(event, page, view) {
                    // Allow page turning
                },
                turned: function(event, page, view) {
                    // Page turned successfully
                }
            }
        });

        // For mobile: add explicit touch event handling to ensure swiping works
        if (isMobile) {
            let touchStartX = 0;
            let touchStartY = 0;
            
            flipbook.addEventListener('touchstart', function(e) {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            }, { passive: true });
            
            flipbook.addEventListener('touchend', function(e) {
                if (!e.changedTouches || !e.changedTouches[0]) return;
                
                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;
                const deltaX = touchEndX - touchStartX;
                const deltaY = touchEndY - touchStartY;
                
                // Only process horizontal swipes (not vertical scrolls)
                if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
                    if (deltaX > 0) {
                        // Swipe right - go to previous page
                        $('#flipbook').turn('previous');
                    } else {
                        // Swipe left - go to next page
                        $('#flipbook').turn('next');
                    }
                }
            }, { passive: true });
        }

        // Handle window resize
        window.addEventListener('resize', function() {
            const newViewportWidth = window.innerWidth;
            const newViewportHeight = window.innerHeight;
            const newIsMobile = newViewportWidth <= 768;
            
            let newPageWidth, newPageHeight, newFlipbookWidth;
            
            if (newIsMobile) {
                // Mobile: single page - prioritize height
                newPageHeight = Math.floor(newViewportHeight * 0.9);
                newPageWidth = Math.floor(newPageHeight * pageAspectRatio);
                
                if (newPageWidth > newViewportWidth * 0.9) {
                    newPageWidth = Math.floor(newViewportWidth * 0.9);
                    newPageHeight = Math.floor(newPageWidth / pageAspectRatio);
                }
                
                newFlipbookWidth = newPageWidth;
            } else {
                // Desktop: double page spread
                newPageWidth = Math.floor(newViewportWidth / 2.5);
                newPageHeight = Math.floor(newPageWidth / pageAspectRatio);
                
                if (newPageHeight > newViewportHeight * 0.9) {
                    newPageHeight = Math.floor(newViewportHeight * 0.9);
                    newPageWidth = Math.floor(newPageHeight * pageAspectRatio);
                }
                
                newFlipbookWidth = newPageWidth * 2;
            }
            
            $('#flipbook').turn('display', newIsMobile ? 'single' : 'double');
            $('#flipbook').turn('size', newFlipbookWidth, newPageHeight);
        });
    })();
</script>
</body>
</html>